<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no" />
  <title>3D Araba Oyunu — Three.js</title>
  <style>
    /* Basit, mobil-öncelikli stil */
    html,body{height:100%;margin:0;background:#0b0b0f;color:#eee;font-family:Inter,Segoe UI,Roboto,Arial}
    #container{position:fixed;inset:0;display:flex;flex-direction:column}
    canvas{display:block; width:100%; height:100%;}
    .ui {
      position: absolute;
      left: 12px;
      top: 12px;
      z-index: 10;
      display:flex;
      gap:8px;
      align-items:center;
      background:rgba(0,0,0,0.25);
      padding:8px;border-radius:8px;
      backdrop-filter:blur(6px);
    }
    .ui button, .ui select {
      background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(255,255,255,0.06);
      padding:8px 10px;border-radius:6px;font-size:14px;
    }
    .mobile-controls {
      position: absolute;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 11;
      display: none; /* sadece mobilde gösterilecek */
      gap:10px;
      align-items:center;
    }
    .mobile-controls .btn {
      width:64px;height:64px;border-radius:50%;
      background:linear-gradient(180deg,#2b2b2f,#111);
      color:#fff;border:1px solid rgba(255,255,255,0.06);
      font-size:18px;display:flex;align-items:center;justify-content:center;
      touch-action: none;
    }
    .speedometer {
      position:absolute; right:12px; top:12px; z-index:10;
      background:rgba(0,0,0,0.22); padding:8px 12px; border-radius:8px;
      font-weight:600;
    }
    /* small screens => show mobile controls */
    @media (max-width:900px){
      .mobile-controls{display:flex}
      .ui{display:none} /* masaüstü küçük ekranda UI gizle, mobil için butonlar var */
    }
    /* accessibility: focus outlines */
    button:focus{outline:3px solid rgba(255,255,255,0.12);outline-offset:2px}
    /* loading overlay */
    #loading {
      position: absolute; inset:0; display:flex;align-items:center;justify-content:center;
      z-index:20;background:linear-gradient(180deg, rgba(6,6,8,0.6), rgba(6,6,8,0.55));
      font-size:18px;backdrop-filter: blur(4px);
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="loading">Yükleniyor... (model + sahne)</div>

    <div class="ui" role="region" aria-label="Oyun Kontrolleri">
      <button id="startBtn">Oyna</button>
      <label for="camSelect" style="font-size:13px">Kamera</label>
      <select id="camSelect" aria-label="Kamera seçimi">
        <option value="third">Üçüncü Kişi</option>
        <option value="chase">Takip Kamerası</option>
        <option value="roof">Tavan / Kuşbakışı</option>
      </select>
      <button id="resetBtn">Reset</button>
    </div>

    <div class="speedometer" aria-live="polite">Hız: 0 km/h</div>

    <!-- Mobil kontroller -->
    <div class="mobile-controls" role="region" aria-label="Mobil Kontroller">
      <div style="display:flex;gap:10px;align-items:center">
        <div class="btn" id="leftBtn" aria-label="Sola">◀</div>
        <div class="btn" id="accelBtn" aria-label="Hızlan">▲</div>
        <div class="btn" id="rightBtn" aria-label="Sağa">▶</div>
        <div class="btn" id="brakeBtn" aria-label="Fren">▼</div>
      </div>
    </div>

    <canvas id="c"></canvas>
  </div>

  <!-- Three.js ve yardımcı modüller (ES module) -->
  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.154.0/build/three.module.js';
    import { GLTFLoader } from 'https://unpkg.com/three@0.154.0/examples/jsm/loaders/GLTFLoader.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.154.0/examples/jsm/controls/OrbitControls.js';
    // (İleri seviye fizik isterseniz Cannon/Ammo entegrasyonu eklenebilir.)

    // --- Temel sahne ---
    const canvas = document.getElementById('c');
    const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0b1220);

    const cameraThird = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 500);
    cameraThird.position.set(0, 6, 12);

    // chase camera (takip)
    const cameraChase = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 500);
    cameraChase.position.set(0, 3, -8);

    const cameraRoof = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 500);
    cameraRoof.position.set(0, 30, 0);
    cameraRoof.lookAt(0, 0, 0);

    let activeCamera = cameraThird;

    // Işık
    const hemi = new THREE.HemisphereLight(0xffffff, 0x444455, 0.6);
    hemi.position.set(0, 20, 0);
    scene.add(hemi);

    const dir = new THREE.DirectionalLight(0xffffff, 1.0);
    dir.position.set(10, 20, 10);
    dir.castShadow = true;
    dir.shadow.camera.left = -30; dir.shadow.camera.right = 30;
    dir.shadow.camera.top = 30; dir.shadow.camera.bottom = -30;
    dir.shadow.mapSize.set(2048, 2048);
    scene.add(dir);

    // Zemin
    const groundMat = new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 0.85, metalness: 0.03 });
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(400, 400), groundMat);
    ground.rotation.x = -Math.PI/2;
    ground.receiveShadow = true;
    scene.add(ground);

    // Yol çizgileri (basit)
    const laneMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
    for (let i = -2; i <= 2; i++){
      const stripe = new THREE.Mesh(new THREE.PlaneGeometry(2, 20), laneMat);
      stripe.rotation.x = -Math.PI/2;
      stripe.position.set(i*4, 0.01, -10);
      stripe.material.opacity = 0.12; stripe.material.transparent = true;
      scene.add(stripe);
    }

    // Basit araba (varsayılan) — GLTF gelmezse bu kullanılır
    const car = new THREE.Group();
    {
      const body = new THREE.Mesh(new THREE.BoxGeometry(2.2, 0.6, 4), new THREE.MeshStandardMaterial({color:0xff3333, metalness:0.4, roughness:0.35}));
      body.position.y = 0.6; body.castShadow = true; car.add(body);

      const cabin = new THREE.Mesh(new THREE.BoxGeometry(1.6,0.5,1.6), new THREE.MeshStandardMaterial({color:0x222222, metalness:0.2, roughness:0.2}));
      cabin.position.set(0,1.05,-0.05); cabin.castShadow = true; car.add(cabin);

      const wheelGeo = new THREE.CylinderGeometry(0.35,0.35,0.45,24);
      const wheelMat = new THREE.MeshStandardMaterial({color:0x111111, metalness:0.1, roughness:0.8});
      function wheel(x,z){ const w = new THREE.Mesh(wheelGeo,wheelMat); w.rotation.z = Math.PI/2; w.position.set(x,0.35,z); w.castShadow=true; car.add(w); }
      wheel(-0.9,1.3); wheel(0.9,1.3); wheel(-0.9,-1.25); wheel(0.9,-1.25);
    }
    car.position.set(0,0,0);
    scene.add(car);

    // Kamera kontroller (masaüstü için orbit kontrol)
    const orbit = new OrbitControls(cameraThird, renderer.domElement);
    orbit.enableDamping = true;
    orbit.target.set(0,0.7,0);

    // Basit oyun durumu
    let state = {
      started: false,
      velocity: 0,      // m/s benzeri
      maxSpeed: 40,     // km/h cinsine çevrilecek
      accel: 20,        // km/h^2 benzeri (basit)
      steer: 0,         // -1..1
      position: new THREE.Vector3(),
      rotationY: 0
    };

    // Input (klavye + mobil)
    const keys = { ArrowUp:false, ArrowDown:false, ArrowLeft:false, ArrowRight:false, w:false,a:false,s:false,d:false };
    window.addEventListener('keydown', (e) => {
      if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','w','a','s','d'].includes(e.key)) {
        keys[e.key] = true;
        e.preventDefault();
      }
      if (e.key === ' ') toggleStart();
    });
    window.addEventListener('keyup', (e) => { if (keys[e.key] !== undefined) keys[e.key] = false; });

    // Mobil butonları
    const leftBtn = document.getElementById('leftBtn');
    const rightBtn = document.getElementById('rightBtn');
    const accelBtn = document.getElementById('accelBtn');
    const brakeBtn = document.getElementById('brakeBtn');

    function bindTouch(el, onDown, onUp){
      el.addEventListener('pointerdown', (e)=>{ e.preventDefault(); onDown(); });
      window.addEventListener('pointerup', (e)=>{ onUp(); });
      el.addEventListener('pointercancel', ()=> onUp());
      el.addEventListener('touchstart', (e)=>e.preventDefault(), {passive:false});
    }
    bindTouch(leftBtn, ()=> keys.ArrowLeft = true, ()=> keys.ArrowLeft = false);
    bindTouch(rightBtn, ()=> keys.ArrowRight = true, ()=> keys.ArrowRight = false);
    bindTouch(accelBtn, ()=> keys.ArrowUp = true, ()=> keys.ArrowUp = false);
    bindTouch(brakeBtn, ()=> keys.ArrowDown = true, ()=> keys.ArrowDown = false);

    // UI butonları
    document.getElementById('startBtn').addEventListener('click', toggleStart);
    document.getElementById('resetBtn').addEventListener('click', resetCar);
    document.getElementById('camSelect').addEventListener('change', (e)=>{
      const v = e.target.value;
      if (v === 'third') activeCamera = cameraThird;
      else if (v === 'chase') activeCamera = cameraChase;
      else if (v === 'roof') activeCamera = cameraRoof;
    });

    function toggleStart(){
      state.started = !state.started;
      document.getElementById('startBtn').textContent = state.started ? 'Duraklat' : 'Oyna';
    }

    function resetCar(){
      state.velocity = 0;
      state.position.set(0,0,0);
      state.rotationY = 0;
      car.position.copy(state.position);
      car.rotation.y = state.rotationY;
    }

    // GLTF yükleme (isteğe bağlı, kendi modelinizi buraya koyun)
    const loading = document.getElementById('loading');
    const loader = new GLTFLoader();
    // Eğer elinizde bir GLB/GLTF URL'si varsa onu buraya koyun; yoksa default kutu araba kullanılır.
    const MODEL_URL = ''; // örn: 'assets/models/car.glb'
    if (MODEL_URL) {
      loader.load(MODEL_URL, (g) => {
        // Model geldiğinde eski basit arabayı kaldırıp kullan
        scene.remove(car);
        const model = g.scene || g;
        model.traverse(n => { if (n.isMesh){ n.castShadow=true; n.receiveShadow=true; } });
        model.scale.setScalar(1);
        model.position.copy(state.position);
        scene.add(model);
        // model referansını car olarak kullanacağımızı varsayalım
      }, undefined, (err) => {
        console.warn('Model yüklenirken hata:', err);
      });
    }

    // Zaman yönetimi
    let last = performance.now();
    function animate(t){
     
